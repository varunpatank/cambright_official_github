<!DOCTYPE html>
<html>
<head>
    <title>Video Upload Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .upload-area { border: 2px dashed #ccc; padding: 20px; margin: 20px 0; }
        .progress { width: 100%; height: 20px; background: #f0f0f0; margin: 10px 0; }
        .progress-bar { height: 100%; background: #4CAF50; transition: width 0.3s; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Video Upload Test</h1>
    
    <div class="upload-area">
        <input type="file" id="videoFile" accept="video/*" />
        <br><br>
        <button onclick="uploadVideo()">Upload Video</button>
    </div>
    
    <div class="progress">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
    </div>
    
    <div id="status"></div>
    
    <div class="log" id="log"></div>

    <script>
        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toISOString();
            logEl.innerHTML += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        async function uploadVideo() {
            const fileInput = document.getElementById('videoFile');
            const file = fileInput.files[0];
            
            if (!file) {
                log('ERROR: No file selected');
                return;
            }
            
            log(`Starting upload for: ${file.name}`);
            log(`File size: ${file.size} bytes (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
            log(`File type: ${file.type}`);
            
            const formData = new FormData();
            formData.append('files', file);
            
            try {
                log('Sending request to /api/minio-upload?endpoint=chapterVideo');
                
                const response = await fetch('/api/minio-upload?endpoint=chapterVideo', {
                    method: 'POST',
                    body: formData
                });
                
                log(`Response status: ${response.status}`);
                log(`Response headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}`);
                
                const responseText = await response.text();
                log(`Raw response text: ${responseText}`);
                
                try {
                    const result = JSON.parse(responseText);
                    log(`Parsed response: ${JSON.stringify(result, null, 2)}`);
                    
                    if (result.success) {
                        log('SUCCESS: Upload completed');
                        document.getElementById('status').innerHTML = `<p style="color: green;">Upload successful! URL: <a href="${result.files[0].url}" target="_blank">${result.files[0].url}</a></p>`;
                    } else {
                        log(`ERROR: ${result.error}`);
                        if (result.details) log(`Details: ${result.details}`);
                        if (result.debugInfo) log(`Debug info: ${JSON.stringify(result.debugInfo, null, 2)}`);
                        document.getElementById('status').innerHTML = `<p style="color: red;">Upload failed: ${result.error}</p>`;
                    }
                } catch (parseError) {
                    log(`ERROR: Failed to parse JSON response: ${parseError.message}`);
                    log(`Response was: ${responseText}`);
                    document.getElementById('status').innerHTML = `<p style="color: red;">Upload failed: Invalid response format</p>`;
                }
                
            } catch (error) {
                log(`ERROR: Network or other error: ${error.message}`);
                document.getElementById('status').innerHTML = `<p style="color: red;">Upload failed: ${error.message}</p>`;
            }
        }

        // Auto-scroll log
        window.addEventListener('load', () => {
            log('Video upload test page loaded');
            log('Select a video file and click Upload Video to test');
        });
    </script>
</body>
</html>
